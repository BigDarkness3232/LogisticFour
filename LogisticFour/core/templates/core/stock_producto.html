{% extends "core/base.html" %}
{% block title %}Ver stock por producto{% endblock %}

{% block content %}
<style>
  /* ===== Layout ancho y centrado ===== */
  .page-wrap { max-width: 1400px; margin-inline: auto; }
  @media (min-width:1800px){ .page-wrap{ max-width: 1600px; } }

  /* ---------- Micro-UI y animaciones ---------- */
  .fade-in { animation: fadeIn .35s ease both; }
  @keyframes fadeIn { from {opacity:0; transform: translateY(4px);} to {opacity:1; transform:none;} }

  .metric {
    border: 1px solid var(--bs-border-color);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    background: var(--bs-body-bg);
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .metric:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(0,0,0,.06); }
  .metric .label { font-size:.825rem; color: var(--bs-secondary-color); }
  .metric .value { font-weight: 700; font-size: clamp(1.2rem, 1.1rem + .6vw, 1.8rem); }

  .card-soft { border-radius: 1rem; border: 1px solid var(--bs-border-color); box-shadow: 0 1px 0 rgba(0,0,0,.02); }

  .search-wrap { position: sticky; top: .75rem; z-index: 2; backdrop-filter: blur(6px); }

  .sku-chip { background: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color);
    border-radius: 999px; padding: .25rem .6rem; font-size:.85rem; }

  .table thead th { position: sticky; top: 0; background: var(--bs-body-bg); z-index: 1; }
  .td-num { text-align: right; white-space: nowrap; }

  .empty { border: 1px dashed var(--bs-border-color); border-radius: 1rem; padding: 1rem;
    color: var(--bs-secondary-color); background: var(--bs-tertiary-bg); }

  .accordion-button:focus { box-shadow: none; }
  .accordion-button { border-radius: .75rem !important; }
  .accordion-item { border: none; margin-bottom: .5rem; }
  .accordion-body { padding-top: .75rem; }

  /* === Botones del mismo ancho + separación cómoda === */
  .btn-action { min-width: 140px; }  /* Buscar / Limpiar */
  .btn-same   { min-width: 130px; }  /* Copiar SKU / Ver ficha */
</style>

<!-- Full width -->
<div class="container-fluid py-4">
  <div class="page-wrap">

    <!-- Buscador -->
    <div class="search-wrap mb-4">
      <form method="get" class="row g-3 align-items-center fade-in">
        <div class="col-12 col-lg-7 col-xxl-8">
          <input id="skuInput" type="text" name="sku" class="form-control form-control-lg"
                 placeholder="Escanea o escribe el SKU (ej. 001-002-117)" value="{{ sku|default:'' }}" autofocus>
        </div>
        <div class="col-12 col-lg-5 col-xxl-4">
          <div class="d-flex gap-3">
            <button class="btn btn-primary btn-lg btn-action" type="submit">Buscar</button>
            <a class="btn btn-outline-secondary btn-lg btn-action" href="{% url 'stock-por-producto' %}">Limpiar</a>
          </div>
        </div>
      </form>
    </div>

    {% if producto %}
      <!-- Header producto -->
      <div class="card card-soft mb-3 fade-in">
        <div class="card-body d-flex flex-wrap gap-3 justify-content-between align-items-start">
          <div>
            <h4 class="mb-1">{{ producto.nombre }}</h4>
            <div class="d-flex flex-wrap gap-2 small">
              <span class="sku-chip">SKU: <strong>{{ producto.sku }}</strong></span>
              <span class="sku-chip">Marca: <strong>{{ producto.marca|default:"—" }}</strong></span>
              <span class="sku-chip">Categoría: <strong>{{ producto.categoria|default:"—" }}</strong></span>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button id="copySku" class="btn btn-outline-secondary btn-same">Copiar SKU</button>
            <a href="{% url 'producto-detail' producto.id %}" class="btn btn-outline-primary btn-same">Ver ficha</a>
          </div>
        </div>
      </div>

      <!-- Métricas globales -->
      <div class="row g-3 mb-4 fade-in">
        <div class="col-12 col-md-4">
          <div class="metric h-100">
            <div class="label">Disponible total</div>
            <div class="value text-success">{{ totales.total_disponible|default_if_none:0|floatformat:2 }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="metric h-100">
            <div class="label">Reservado total</div>
            <div class="value text-warning">{{ totales.total_reservado|default_if_none:0|floatformat:2 }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="metric h-100">
            <div class="label">Neto total</div>
            <div class="value {% if totales.total_neto|default:0 > 0 %}text-primary{% else %}text-body{% endif %}">
              {{ totales.total_neto|default_if_none:0|floatformat:2 }}
            </div>
          </div>
        </div>
      </div>

      <!-- Resumen por sucursal -->
      <div class="card card-soft mb-4 fade-in">
        <div class="card-header bg-transparent">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Stock por Sucursal</strong>
            <span class="text-secondary small">{{ resumen_sucursales|length }} sucursal(es)</span>
          </div>
        </div>
        <div class="card-body p-0">
          {% if resumen_sucursales %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead class="border-bottom">
                  <tr>
                    <th>Sucursal</th>
                    <th class="td-num" style="width: 15%;">Disponible</th>
                    <th class="td-num" style="width: 15%;">Reservado</th>
                    <th class="td-num" style="width: 15%;">Neto</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in resumen_sucursales %}
                  <tr class="fade-in" style="animation-delay: {{ forloop.counter0|add:0 }}00ms;">
                    <td>
                      <span class="fw-semibold">{{ r.ubicacion__bodega__sucursal__codigo }}</span>
                      <span class="text-secondary">— {{ r.ubicacion__bodega__sucursal__nombre }}</span>
                    </td>
                    <td class="td-num">{{ r.total_disponible|floatformat:2 }}</td>
                    <td class="td-num">{{ r.total_reservado|floatformat:2 }}</td>
                    <td class="td-num fw-semibold">{{ r.total_neto|floatformat:2 }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-4 empty">No hay stock registrado por sucursal para este producto.</div>
          {% endif %}
        </div>
      </div>

      <!-- Detalle por bodega (acordeón por sucursal) -->
      <div class="card card-soft fade-in">
        <div class="card-header bg-transparent">
          <div class="d-flex align-items-center justify-content-between">
            <strong>Detalle por Bodega</strong>
            <span class="text-secondary small">{{ resultados_bodegas|length }} registro(s)</span>
          </div>
        </div>
        <div class="card-body">
          {% if resultados_bodegas %}
            {% regroup resultados_bodegas by ubicacion__bodega__sucursal__codigo as grupos %}
            <div class="accordion" id="accSucursales">
              {% for g in grupos %}
                {% with scode=g.grouper %}
                <div class="accordion-item fade-in">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#suc-{{ scode|slugify }}" aria-expanded="false">
                      <div class="d-flex flex-column">
                        <span class="fw-semibold">Sucursal {{ scode }}</span>
                        <small class="text-secondary">
                          {{ g.list.0.ubicacion__bodega__sucursal__nombre }} · {{ g.list|length }} bodega(s)
                        </small>
                      </div>
                    </button>
                  </h2>
                  <div id="suc-{{ scode|slugify }}" class="accordion-collapse collapse" data-bs-parent="#accSucursales">
                    <div class="accordion-body">
                      <div class="table-responsive">
                        <table class="table align-middle mb-0">
                          <thead class="border-bottom">
                            <tr>
                              <th style="min-width: 280px;">Bodega</th>
                              <th class="td-num" style="width: 15%;">Disponible</th>
                              <th class="td-num" style="width: 15%;">Reservado</th>
                              <th class="td-num" style="width: 15%;">Neto</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for r in g.list %}
                            <tr>
                              <td>
                                <span class="fw-semibold">{{ r.ubicacion__bodega__codigo }}</span>
                                <span class="text-secondary">— {{ r.ubicacion__bodega__nombre }}</span>
                              </td>
                              <td class="td-num">{{ r.total_disponible|floatformat:2 }}</td>
                              <td class="td-num">{{ r.total_reservado|floatformat:2 }}</td>
                              <td class="td-num fw-semibold">{{ r.total_neto|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                {% endwith %}
              {% endfor %}
            </div>
          {% else %}
            <div class="empty">No hay stock registrado por bodega para este producto.</div>
          {% endif %}
        </div>
      </div>

    {% elif sku %}
      <div class="empty fade-in">Producto no encontrado.</div>
    {% else %}
      <div class="empty fade-in">Escribe o escanea un SKU para comenzar.</div>
    {% endif %}

  </div><!-- /.page-wrap -->
</div><!-- /.container-fluid -->

<script>
  // Copiar SKU al portapapeles + feedback visual
  (function() {
    const btn = document.getElementById('copySku');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText('{{ producto.sku }}');
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        btn.textContent = 'SKU copiado';
        setTimeout(() => {
          btn.classList.remove('btn-success');
          btn.classList.add('btn-outline-secondary');
          btn.textContent = 'Copiar SKU';
        }, 1400);
      } catch(e) { console.warn(e); }
    });
  })();

  // Scroll suave al cargar con query
  (function() {
    const p = new URLSearchParams(window.location.search);
    if (p.get('sku')) { setTimeout(() => { window.scrollTo({top: 0, behavior: 'smooth'}); }, 50); }
  })();
</script>
{% endblock %}
