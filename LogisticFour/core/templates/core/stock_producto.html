{% extends "core/base.html" %}
{% load static %}
{% block title %}Ver stock por producto{% endblock %}

{% block content %}
<style>
  .page-wrap { max-width: 1400px; margin-inline: auto; }
  .fade-in { animation: fadeIn .35s ease both; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
  .empty { border:1px dashed var(--bs-border-color); border-radius:1rem; padding:1rem;
           color:var(--bs-secondary-color); background:var(--bs-tertiary-bg); }
  .btn-action{ min-width:140px }

  /* bot√≥n de c√°mara pegado al input */
  .btn-scan{ display:inline-flex; align-items:center; justify-content:center; width:46px }
  .btn-scan svg{ width:20px; height:20px }

  /* ==== estilos del modal del esc√°ner ==== */
  .bs-cam{position:relative;border-radius:16px;overflow:hidden;background:#0b0b0b}
  .bs-vid{width:100%;height:100%;object-fit:cover;background:#000}
  .bs-overlay{position:absolute;inset:0;pointer-events:none;display:none}
  .bs-mask{position:absolute;inset:0;background:
    linear-gradient(to bottom,rgba(0,0,0,.5) calc((100% - 32%)/2),
    transparent calc((100% - 32%)/2), transparent calc((100% + 32%)/2),
    rgba(0,0,0,.5) calc((100% + 32%)/2))}
  .bs-frame{position:absolute;left:6%;right:6%;top:calc((100% - 32%)/2);height:32%;
    border:2px dashed rgba(255,255,255,.8);border-radius:12px}
  .bs-fab{position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:5}
  .bs-fab .btn{padding:.35rem .55rem;line-height:1}
  .bs-primary{display:block;width:100%;padding:.9rem 1rem;font-size:1.05rem}
</style>

<div class="container-fluid py-4">
  <div class="page-wrap">
    <!-- Buscador -->
    <div class="mb-4">
      <form method="get" class="row g-3 align-items-center fade-in" id="searchForm">
        <div class="col-12 col-lg-7 col-xxl-8">
          <div class="input-group input-group-lg">
            <button type="button" class="btn btn-outline-secondary btn-scan" id="btnOpenScanner"
                    title="Escanear con c√°mara" aria-label="Escanear con c√°mara">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
              </svg>
            </button>
            <input id="skuInput" name="sku" class="form-control"
                   placeholder="Escanea o escribe el SKU (ej. 001-002-117)"
                   value="{{ sku|default:'' }}" autocomplete="off" autofocus>
          </div>
        </div>
        <div class="col-12 col-lg-5 col-xxl-4">
          <div class="d-flex gap-3">
            <button class="btn btn-primary btn-lg btn-action" type="submit">Buscar</button>
            <a class="btn btn-outline-secondary btn-lg btn-action" href="{% url 'stock-por-producto' %}">Limpiar</a>
          </div>
        </div>
      </form>
    </div>

    {% if producto %}
      <!-- ‚Ä¶ tu bloque de resultados tal como lo ten√≠as ‚Ä¶ -->
    {% elif sku %}
      <div class="empty fade-in">Producto no encontrado.</div>
    {% else %}
      <div class="empty fade-in">Escribe o escanea un SKU para comenzar.</div>
    {% endif %}
  </div>
</div>

{# Bootstrap (si no lo cargas en base.html) #}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ZXing y Quagga se cargan on-demand desde el propio script -->
<script>
/* ===== Esc√°ner reutilizable (modal minimal) ===== */
(function(){
  const ZXING_URL="https://unpkg.com/@zxing/library@0.21.3";
  const QUAGGA_URL="https://unpkg.com/quagga2@1.8.4/dist/quagga.js";
  const ROI_RATIO=0.32, LIVE_INTERVAL_MS=550, SCALE_MAX_W=1200, FALLBACK_EVERY=4;

  const qs=(s,r=document)=>r.querySelector(s);
  const loadOnce=(src)=>new Promise((ok,ko)=>{
    if(document.querySelector(`script[src^="${src}"]`)) return ok();
    const s=document.createElement('script'); s.src=src; s.onload=ok; s.onerror=ko; document.head.appendChild(s);
  });
  const ensureLibs=()=>Promise.all([loadOnce(ZXING_URL),loadOnce(QUAGGA_URL)]);
  const show=(el,msg,ok=true)=>{el.className=`alert ${ok?'alert-success':'alert-danger'} mt-2`;el.textContent=msg;el.classList.remove('d-none')};
  const info=(el,msg)=>{el.className='alert alert-info mt-2';el.textContent=msg;el.classList.remove('d-none')};
  const hide=(el)=>el.classList.add('d-none');

  function ensureModal(){
    if(qs('#barcodeModal')) return;
    const html = `
    <div class="modal fade" id="barcodeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down" style="max-width:950px">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bsTitle">Escanear c√≥digo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="ratio ratio-16x9 bs-cam" id="bsCamBox">
              <video id="bsVideo" class="bs-vid" playsinline muted></video>
              <div class="bs-overlay" id="bsOverlay"><div class="bs-mask"></div><div class="bs-frame"></div></div>
              <div class="bs-fab">
                <button id="bsFlip" class="btn btn-light btn-sm" title="Cambiar c√°mara">‚Ü∫</button>
                <button id="bsTorch" class="btn btn-warning btn-sm d-none" title="Linterna">üí°</button>
              </div>
            </div>
            <button id="bsLive" class="btn btn-primary bs-primary mt-3">Escanear</button>
            <div id="bsResult" class="alert alert-info d-none mt-2"></div>
          </div>
          <div class="modal-footer">
            <small class="text-muted me-auto">FPS: <span id="bsFps">0</span></small>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>`;
    const d=document.createElement('div'); d.innerHTML=html; document.body.appendChild(d.firstElementChild);
  }

  function drawScaled(img,maxW){
    const sc=Math.min(1,maxW/img.width), w=Math.round(img.width*sc), h=Math.round(img.height*sc);
    const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); return c;
  }
  function captureROI(video){
    const vw=video.videoWidth||1280, vh=video.videoHeight||720;
    const rh=Math.floor(vh*ROI_RATIO), y=Math.floor((vh-rh)/2);
    const c=document.createElement('canvas'); c.width=vw; c.height=rh;
    c.getContext('2d').drawImage(video,0,y,vw,rh,0,0,vw,rh);
    return c.toDataURL('image/png');
  }
  async function tryZXing(img,formats){
    try{
      const hints=new Map(), set=[];
      (formats||[]).forEach(f=> ZXing.BarcodeFormat[f] && set.push(ZXing.BarcodeFormat[f]));
      if(set.length) hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS,set);
      hints.set(ZXing.DecodeHintType.TRY_HARDER,true);
      const reader=new ZXing.BrowserMultiFormatReader();
      const res=await reader.decodeFromImage(img,hints).catch(()=>null);
      if(!res) return null;
      return (typeof res.getText==='function') ? res.getText() : (res.text||null);
    }catch{ return null; }
  }
  function tryQuaggaFromCanvas(canvas){
    return new Promise(resolve=>{
      try{
        Quagga.decodeSingle({
          src: canvas.toDataURL('image/png'), numOfWorkers:0,
          inputStream:{ size:SCALE_MAX_W },
          decoder:{ readers:["ean_reader","ean_8_reader","upc_reader","upc_e_reader","code_128_reader","code_39_reader"] },
          locate:true
        }, r=> resolve(r && r.codeResult && r.codeResult.code ? r.codeResult.code : null));
      }catch{ resolve(null); }
    });
  }
  async function decodeDataURLTo(target,label,dataUrl,fast=false, ref={val:0}){
    try{
      info(target,`Procesando ${label}‚Ä¶`);
      const img=await new Promise((ok,ko)=>{const i=new Image();i.onload=()=>ok(i);i.onerror=ko;i.src=dataUrl;});
      const canvas=drawScaled(img,SCALE_MAX_W);

      let code=await tryZXing(img,["EAN_13"]);
      if(code){ show(target,`Le√≠do (${label}/ZXing): ${code}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return code; }

      const wide = !fast || (fast && (ref.val % FALLBACK_EVERY === 0));
      if(wide){
        code=await tryZXing(img,["EAN_13","EAN_8","UPC_A","UPC_E","CODE_128","CODE_39"]);
        if(code){ show(target,`Le√≠do (${label}/ZXing+): ${code}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return code; }
        const q=await tryQuaggaFromCanvas(canvas);
        if(q){ show(target,`Le√≠do (${label}/Quagga): ${q}`,true); try{navigator.vibrate&&navigator.vibrate(25)}catch{}; return q; }
      }
      if(fast){ info(target,"Buscando‚Ä¶ centra el c√≥digo."); return null; }
      show(target,`No se pudo leer desde la ${label}.`,false); return null;
    }catch{ show(target,`Error procesando la ${label}.`,false); return null; }
  }

  async function pickRearDeviceId(){
    try{ const s=await navigator.mediaDevices.getUserMedia({video:true}); s.getTracks().forEach(t=>t.stop()); }catch{}
    const cams=(await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
    const rear=cams.find(d=>/back|rear|environment|trase|atr[a√°]s|wide/i.test(d.label));
    return rear?.deviceId || cams[0]?.deviceId || null;
  }

  async function open({title="Escanear", onScan=null, continuous=false, preferFacing='environment'}={}){
    await ensureLibs(); ensureModal();

    const modalEl=qs('#barcodeModal'), titleEl=qs('#bsTitle'), video=qs('#bsVideo'),
          overlay=qs('#bsOverlay'), liveBtn=qs('#bsLive'), flipBtn=qs('#bsFlip'),
          torchBtn=qs('#bsTorch'), resBox=qs('#bsResult'), fpsEl=qs('#bsFps');

    titleEl.textContent = title;

    let deviceId=null, track=null, liveTimer=null, fpsTimer=null, decoding=false;
    const attemptRef={val:0}; let facing=preferFacing;

    function stopLive(){ if(liveTimer){ clearInterval(liveTimer); liveTimer=null; } }
    function setupTorch(){
      if(!track || !track.getCapabilities){ torchBtn.classList.add('d-none'); return; }
      torchBtn.classList.toggle('d-none', !('torch' in track.getCapabilities()));
    }
    async function ready(vid){ return new Promise(r=>{ if(vid.readyState>=2&&vid.videoWidth) return r(); const f=()=>{ if(vid.videoWidth){ vid.removeEventListener('loadedmetadata',f); r(); } }; vid.addEventListener('loadedmetadata',f); requestAnimationFrame(f); }); }
    function constraints(){
      if(deviceId) return { video:{ deviceId:{exact:deviceId}, width:{ideal:1920}, height:{ideal:1080}, focusMode:"continuous" } };
      return { video:{ facingMode:{ideal:facing}, width:{ideal:1920}, height:{ideal:1080}, focusMode:"continuous" } };
    }
    async function start(){
      stopLive(); hide(resBox);
      try{
        if(!deviceId && facing==='environment') deviceId = await pickRearDeviceId();
        const stream=await navigator.mediaDevices.getUserMedia(constraints());
        video.srcObject=stream; await video.play(); await ready(video);
        track=stream.getVideoTracks()[0]||null; overlay.style.display='';
        setupTorch();
        clearInterval(fpsTimer);
        let last=performance.now();
        fpsTimer=setInterval(()=>{ const now=performance.now(); const fps=1000/(now-last); fpsEl.textContent=isFinite(fps)?fps.toFixed(1):'0'; last=now; },1000);
      }catch(e){
        console.error(e); show(resBox,"No se pudo iniciar la c√°mara. Revisa permisos o usa HTTPS.",false);
        overlay.style.display='none';
      }
    }
    function stop(){
      overlay.style.display='none';
      stopLive();
      if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; track=null; }
      torchBtn.classList.add('d-none');
      clearInterval(fpsTimer);
    }

    liveBtn.onclick = async ()=>{
      if(!video.srcObject) await start();
      await ready(video);
      if(liveTimer) return;
      attemptRef.val=0;
      liveTimer=setInterval(async ()=>{
        if(decoding) return; decoding=true;
        try{
          const dataUrl=captureROI(video);
          const code=await decodeDataURLTo(resBox,'captura',dataUrl,true,attemptRef);
          attemptRef.val++;
          if(code){
            onScan && onScan(code);
            if(!continuous){
              stopLive();
              bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            }
          }
        } finally { decoding=false; }
      }, LIVE_INTERVAL_MS);
    };
    flipBtn.onclick = async ()=>{ facing = (facing==='environment') ? 'user' : 'environment'; deviceId=null; await start(); };
    torchBtn.onclick = async ()=>{ if(!track) return; const s=track.getSettings(); const on=!s.torch; try{ await track.applyConstraints({advanced:[{torch:on}]}); }catch{} };

    modalEl.addEventListener('shown.bs.modal', start, {once:true});
    modalEl.addEventListener('hidden.bs.modal', stop);
    bootstrap.Modal.getOrCreateInstance(modalEl, {backdrop:'static'}).show();
  }

  window.BarcodeScanner = { open };
})();
</script>

<script>
  // Integraci√≥n: abre el modal y vuelca el resultado al input, luego env√≠a el form.
  (function(){
    const input = document.getElementById('skuInput');
    const btn   = document.getElementById('btnOpenScanner');
    const form  = document.getElementById('searchForm');

    btn.addEventListener('click', ()=>{
      if(!window.BarcodeScanner){ alert('Carg√≥ mal el esc√°ner. Revisa conexi√≥n.'); return; }
      BarcodeScanner.open({
        title: 'Escanear SKU',
        continuous: false,
        preferFacing: 'environment',
        onScan: (code)=>{ input.value = code; form.submit(); }
      });
    });
  })();
</script>
{% endblock %}
