{% extends "core/base.html" %}
{% block title %}Ubicaciones{% endblock %}

{% block content %}
<style>
  :root{
    --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --bg:#f5f7fb; --head:#eef0f6;
    --pri:#111; --pri-ink:#fff; --sec-bg:#fff; --sec-ink:#111; --danger:#dc2626;
  }
  .lx-page{display:grid;gap:14px}
  .lx-head{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .lx-head h1{margin:0;font-weight:800}

  /* Filtros */
  .lx-filter{
    background:#fff;border:1px solid var(--line);border-radius:12px;
    padding:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap
  }
  .lx-filter .lx-input,
  .lx-filter select{
    flex:1 1 220px;min-width:200px;padding:10px 12px;border:1px solid var(--line);
    border-radius:10px;background:#fafafa
  }
  .lx-btn{
    background:var(--pri);color:var(--pri-ink);border:0;border-radius:10px;padding:10px 14px;cursor:pointer;
    text-decoration:none; display:inline-flex; align-items:center; gap:6px
  }
  .lx-btn[aria-disabled="true"]{opacity:.6;pointer-events:none}
  .lx-btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}

  /* Tabla */
  .lx-wrap{background:#fff;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .lx-table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  .lx-table thead th{
    position:sticky;top:0;background:var(--head);z-index:1;text-align:left;
    padding:12px;font-weight:700;border-bottom:1px solid var(--line)
  }
  .lx-table tbody td{padding:12px;border-bottom:1px solid var(--line)}
  .lx-table tbody tr:hover{background:#fafafa}
  .lx-actions{white-space:nowrap}

  /* Badges */
  .lx-badge{display:inline-block;padding:4px 8px;font-size:12px;border-radius:999px;border:1px solid var(--line);background:#f8fafc;color:#374151}
  .lx-badge.ok{background:#e8f7ee;color:#065f46;border-color:#bfe7cb}
  .lx-badge.no{background:#fff1f0;color:#7a1d1d;border-color:#f3c3bf}

  /* Acciones */
  .lx-acts{display:flex;gap:8px;flex-wrap:wrap}
  .lx-act{
    display:inline-flex;align-items:center;gap:6px;
    padding:7px 10px;border-radius:10px;font-size:13px;line-height:1;border:1px solid var(--line);
    background:var(--sec-bg);color:var(--sec-ink);text-decoration:none;cursor:pointer
  }
  .lx-act svg{width:14px;height:14px;display:block}
  .lx-act.pri{background:var(--pri);color:var(--pri-ink);border-color:var(--pri)}
  .lx-act.danger{background:#fff;color:var(--danger);border-color:#fecaca}
  .lx-act.danger:hover{background:#fff5f5}
  .lx-act[aria-expanded="true"]{background:var(--pri);color:#fff;border-color:var(--pri)}

  /* Expandible */
  .lx-expand-row td{padding:0!important;background:#fbfbfd}
  .lx-expand{border-top:1px dashed var(--line)}
  .lx-expand__inner{
    display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr));
    padding:12px; opacity:0; max-height:0; overflow:hidden;
    transition:max-height .35s ease, opacity .25s ease;
  }
  .lx-expand.open .lx-expand__inner{opacity:1}

  .lx-kv{display:grid;gap:2px}
  .lx-kv small{color:var(--muted)}

  /* Responsive: tabla → cards */
  @media (max-width:760px){
    .lx-table thead{display:none}
    .lx-table{display:block}
    .lx-table tbody{display:grid;gap:10px}
    .lx-table tr{display:grid;gap:8px;padding:12px;background:#fff;border:1px solid var(--line);border-radius:12px}
    .lx-table td{border:0;padding:0}
    .lx-table td[data-label]::before{content:attr(data-label) ": ";font-weight:600;color:var(--muted);margin-right:6px}
    .lx-expand__inner{grid-template-columns:1fr}
  }
</style>

<!-- Iconos -->
<svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
  <symbol id="icon-eye" viewBox="0 0 24 24"><path d="M12 5c5.5 0 9.7 4.6 10.7 6-.9 1.3-5 6-10.7 6S2.3 12.3 1.3 11c1-1.4 5.2-6 10.7-6Zm0 2c-4.1 0-7.6 3.2-8.9 4.99C4.4 13.8 7.9 17 12 17s7.6-3.2 8.9-5.01C19.6 10.2 16.1 7 12 7Zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5Z"/></symbol>
  <symbol id="icon-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm2 2.5h-.5v-.5l9.56-9.56.5.5L5 19.75ZM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 1 0-1.41 1.41l2.34 2.34c.39.39 1.02.39 1.41 0Z"/></symbol>
  <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M6 7h12l-1 13a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L6 7Zm3-3h6l1 2H8l1-2Zm2 5v9h2V9h-2Z"/></symbol>
</svg>

<div class="lx-page">
  <div class="lx-head">
    <h1>Ubicaciones</h1>
    <a class="lx-btn" href="{% url 'ubicacion-create' %}">➕ Crear ubicación</a>
  </div>

  <!-- Filtros -->
  <form method="get" class="lx-filter" role="search" aria-label="Buscar ubicaciones">
    <input class="lx-input" type="text" name="q" value="{{ request.GET.q }}" placeholder="Buscar por código o nombre…">

    <select name="bodega">
      <option value="">— bodega —</option>
      {% for b in bodegas %}
        <option value="{{ b.id }}" {% if request.GET.bodega|default:'' == b.id|stringformat:'s' %}selected{% endif %}>
          {{ b.sucursal.codigo }} / {{ b.codigo }} — {{ b.nombre }}
        </option>
      {% endfor %}
    </select>

    <select name="area">
      <option value="">— área —</option>
      {% for a in areas %}
        <option value="{{ a.id }}" {% if request.GET.area|default:'' == a.id|stringformat:'s' %}selected{% endif %}>
          {{ a.bodega.codigo }} — {{ a.codigo }} ({{ a.nombre }})
        </option>
      {% endfor %}
    </select>

    <select name="tipo">
      <option value="">— tipo —</option>
      {% for t in tipos %}
        <option value="{{ t.id }}" {% if request.GET.tipo|default:'' == t.id|stringformat:'s' %}selected{% endif %}>
          {{ t.codigo }}
        </option>
      {% endfor %}
    </select>

    <select name="pickeable">
      <option value="">Pickeable</option>
      <option value="1" {% if request.GET.pickeable == '1' %}selected{% endif %}>Sí</option>
      <option value="0" {% if request.GET.pickeable == '0' %}selected{% endif %}>No</option>
    </select>

    <select name="almacenable">
      <option value="">Almacenable</option>
      <option value="1" {% if request.GET.almacenable == '1' %}selected{% endif %}>Sí</option>
      <option value="0" {% if request.GET.almacenable == '0' %}selected{% endif %}>No</option>
    </select>

    <button class="lx-btn" type="submit">Filtrar</button>
    <a class="lx-btn ghost" href="{% url 'ubicacion-list' %}" {% if not request.GET.q and not request.GET.bodega and not request.GET.area and not request.GET.tipo and not request.GET.pickeable and not request.GET.almacenable %}aria-disabled="true"{% endif %}>Limpiar</a>
  </form>

  <!-- Tabla -->
  <div class="lx-wrap">
    <table class="lx-table">
      <thead>
        <tr>
          <th>Sucursal/Bodega</th>
          <th>Código</th>
          <th>Nombre</th>
          <th>Área</th>
          <th>Tipo</th>
          <th>Pickeable</th>
          <th>Almacenable</th>
          <th class="lx-actions">Acciones</th>
        </tr>
      </thead>
      <tbody id="rows-ubi">
        {% for u in ubicaciones %}
          <!-- Fila principal -->
          <tr>
            <td data-label="Sucursal/Bodega">
              {% if u.bodega and u.bodega.sucursal %}
                {{ u.bodega.sucursal.codigo }} / {{ u.bodega.codigo }}
              {% else %}—{% endif %}
            </td>
            <td data-label="Código"><strong class="mono">{{ u.codigo }}</strong></td>
            <td data-label="Nombre">{{ u.nombre|default:"—" }}</td>
            <td data-label="Área">{{ u.area|default:"—" }}</td>
            <td data-label="Tipo">{% if u.tipo %}{{ u.tipo.codigo }}{% else %}—{% endif %}</td>
            <td data-label="Pickeable">{% if u.pickeable %}<span class="lx-badge ok">Sí</span>{% else %}<span class="lx-badge no">No</span>{% endif %}</td>
            <td data-label="Almacenable">{% if u.almacenable %}<span class="lx-badge ok">Sí</span>{% else %}<span class="lx-badge no">No</span>{% endif %}</td>
            <td class="lx-actions" data-label="Acciones">
              <div class="lx-acts">
                <button type="button" class="lx-act pri" data-target="u{{ u.pk }}" aria-controls="u{{ u.pk }}" aria-expanded="false" title="Ver detalle">
                  <svg aria-hidden="true"><use href="#icon-eye"/></svg>
                  Ver
                </button>

                {% url 'ubicacion-edit' u.pk as edit_url %}
                {% url 'ubicacion-delete' u.pk as delete_url %}

                <a class="lx-act" href="{{ edit_url }}" title="Editar">
                  <svg aria-hidden="true"><use href="#icon-edit"/></svg>
                  Editar
                </a>
                <a class="lx-act danger" href="{{ delete_url }}" title="Eliminar" onclick="return confirm('¿Eliminar la ubicación {{ u.codigo }}?')">
                  <svg aria-hidden="true"><use href="#icon-trash"/></svg>
                  Eliminar
                </a>
              </div>
            </td>
          </tr>

          <!-- Fila expandible -->
          <tr id="u{{ u.pk }}" class="lx-expand-row" aria-hidden="true">
            <td colspan="8">
              <div class="lx-expand" data-expand>
                <div class="lx-expand__inner">
                  <div class="lx-kv">
                    <small>Clave</small>
                    <div>
                      {% if u.bodega and u.bodega.sucursal %}{{ u.bodega.sucursal.codigo }}{% else %}—{% endif %}:
                      {% if u.bodega %}{{ u.bodega.codigo }}{% else %}—{% endif %}:
                      {{ u.codigo }}
                    </div>
                  </div>
                  <div class="lx-kv">
                    <small>Descripción de tipo</small>
                    <div>{% if u.tipo and u.tipo.descripcion %}{{ u.tipo.descripcion }}{% else %}—{% endif %}</div>
                  </div>
                  <div class="lx-kv">
                    <small>Creada</small>
                    <div>{{ u.creado_en|date:"d/m/Y H:i" }}</div>
                  </div>
                  <div class="lx-kv">
                    <small>Área</small>
                    <div>{{ u.area|default:"—" }}</div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No hay ubicaciones.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap">
      {% if page_obj.has_previous %}
        <a class="lx-btn ghost" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.bodega %}&bodega={{ request.GET.bodega }}{% endif %}{% if request.GET.area %}&area={{ request.GET.area }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.pickeable %}&pickeable={{ request.GET.pickeable }}{% endif %}{% if request.GET.almacenable %}&almacenable={{ request.GET.almacenable }}{% endif %}">← Anterior</a>
      {% else %}
        <span class="lx-btn ghost" aria-disabled="true">← Anterior</span>
      {% endif %}

      <span class="lx-btn" style="pointer-events:none">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a class="lx-btn ghost" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.bodega %}&bodega={{ request.GET.bodega }}{% endif %}{% if request.GET.area %}&area={{ request.GET.area }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.pickeable %}&pickeable={{ request.GET.pickeable }}{% endif %}{% if request.GET.almacenable %}&almacenable={{ request.GET.almacenable }}{% endif %}">Siguiente →</a>
      {% else %}
        <span class="lx-btn ghost" aria-disabled="true">Siguiente →</span>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
/* Acordeón con animación y cierre automático */
(function(){
  const tbody = document.getElementById('rows-ubi');
  if(!tbody) return;

  tbody.querySelectorAll('.lx-expand').forEach(w => {
    const inner = w.querySelector('.lx-expand__inner');
    if(inner){
      inner.style.maxHeight = '0px';
      inner.style.opacity = '0';
    }
  });

  function closeAll(){
    tbody.querySelectorAll('.lx-act.pri[aria-expanded="true"]').forEach(b=> b.setAttribute('aria-expanded','false'));
    tbody.querySelectorAll('.lx-expand').forEach(w=>{
      const inner = w.querySelector('.lx-expand__inner');
      const row = w.closest('.lx-expand-row');
      if(inner){ inner.style.maxHeight = '0px'; inner.style.opacity = '0'; }
      w.classList.remove('open');
      if(row) row.setAttribute('aria-hidden','true');
    });
  }

  function openWrap(btn, wrap){
    const inner = wrap.querySelector('.lx-expand__inner');
    const row = wrap.closest('.lx-expand-row');
    if(!inner) return;
    inner.style.maxHeight = inner.scrollHeight + 'px';
    inner.style.opacity = '1';
    wrap.classList.add('open');
    if(row) row.setAttribute('aria-hidden','false');
    btn.setAttribute('aria-expanded','true');
    setTimeout(()=>{ wrap.scrollIntoView({behavior:'smooth', block:'nearest'}); }, 20);
  }

  tbody.addEventListener('click', (e)=>{
    const btn = e.target.closest('.lx-act.pri');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const row = document.getElementById(id);
    if(!row) return;
    const wrap = row.querySelector('[data-expand]');
    const isOpen = btn.getAttribute('aria-expanded') === 'true';
    closeAll();
    if(!isOpen) openWrap(btn, wrap);
  });
})();
</script>
{% endblock %}
