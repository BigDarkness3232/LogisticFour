{% extends "core/base.html" %}
{% load static %}

{% block title %}Test — Lector de Códigos{% endblock %}

{% block content %}
<div class="container py-4" style="max-width:820px">
  <h3 class="mb-3">Prueba del Lector de Códigos</h3>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Probar componente</h5>

      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-primary" id="btnOpenOnce">Abrir escáner</button>
        <button class="btn btn-outline-secondary" id="btnOpenStream">Modo continuo</button>
      </div>

      <div class="mt-3">
        <label for="sku" class="form-label">SKU / Código</label>
        <div class="d-flex gap-2">
          <input id="sku" class="form-control" placeholder="Resultado irá aquí"/>
          <button type="button" class="btn btn-outline-dark" id="btnScanSku">Escanear</button>
        </div>
      </div>

      <hr>
      <h6 class="mt-2">Último resultado</h6>
      <pre id="lastResult" class="bg-light p-3 rounded border small mb-2">—</pre>

      <h6>Historial (reciente → antiguo)</h6>
      <ul id="history" class="list-group small"></ul>
    </div>
  </div>

  <div class="alert alert-info">
    <b>Tip:</b> En móviles usa <b>HTTPS</b> (ngrok). Acepta el permiso de cámara cuando el navegador lo pida.
  </div>
</div>

{# Si tu base ya carga Bootstrap, puedes quitar estas 2 líneas. #}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{# Componente reutilizable #}
<script src="{% static 'js/barcode_scanner.js' %}?v=3"></script>

<script>
(function(){
  const lastEl = document.getElementById('lastResult');
  const histEl = document.getElementById('history');

  function pushHistory(code){
    if (lastEl) lastEl.textContent = code;
    if (!histEl) return;
    const li = document.createElement('li');
    const ts = new Date().toLocaleTimeString();
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `<code class="small">${code}</code><span class="badge bg-secondary">${ts}</span>`;
    histEl.prepend(li);
  }

  // Abrir una sola vez (cierra al leer)
  const btnOpenOnce = document.getElementById('btnOpenOnce');
  if (btnOpenOnce) {
    btnOpenOnce.addEventListener('click', ()=>{
      if (!window.BarcodeScanner){ alert('BarcodeScanner no está cargado. Revisa /static/js/barcode_scanner.js'); return; }
      BarcodeScanner.open({
        title: 'Escanear producto',
        continuous: false,
        preferFacing: 'environment',
        onScan: (code)=> { console.log('[ONCE]', code); pushHistory(code); }
      });
    });
  }

  // Modo continuo (no cierra)
  const btnOpenStream = document.getElementById('btnOpenStream');
  if (btnOpenStream) {
    btnOpenStream.addEventListener('click', ()=>{
      if (!window.BarcodeScanner){ alert('BarcodeScanner no está cargado. Revisa /static/js/barcode_scanner.js'); return; }
      BarcodeScanner.open({
        title: 'Modo continuo',
        continuous: true,
        preferFacing: 'environment',
        onScan: (code)=> { console.log('[STREAM]', code); pushHistory(code); }
      });
    });
  }

  // Adjuntar al input (al hacer clic en el botón al lado del input)
  const btnScanSku = document.getElementById('btnScanSku');
  if (btnScanSku) {
    btnScanSku.addEventListener('click', ()=>{
      if (!window.BarcodeScanner){ alert('BarcodeScanner no está cargado. Revisa /static/js/barcode_scanner.js'); return; }
      // Abre directamente (sin necesidad de attach persistente)
      BarcodeScanner.open({
        title: 'Escanear SKU',
        continuous: false,
        preferFacing: 'environment',
        onScan: (code)=> {
          const sku = document.getElementById('sku');
          if (sku) {
            sku.value = code;
            sku.dispatchEvent(new Event('change', {bubbles:true}));
          }
          pushHistory(code);
        }
      });
    });
  }
})();
</script>
{% endblock %}
